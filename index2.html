<!DOCTYPE html>
<html>
  <head>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  </head>
  <body>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: 607,
        height: 703,
        parent: "phaser-example",
        pixelArt: true,
        backgroundColor: "#1a1a2d",
        physics: {
        default: 'arcade',
        arcade: { debug: true }
    },
        scene: {
          preload: preload,
          create: create,
        },
      };

      var game = new Phaser.Game(config);

      function preload() {
        this.load.image("tiles", "assets/drawtiles-spaced.png");
        this.load.image("pacman", "assets/Pacman.png");
        this.load.tilemapCSV("map", "assets/grid.csv");
        this.load.image("ghost1", "assets/Ghost1.png");
        this.load.image("ghost2", "assets/Ghost2.png");
        this.load.image("ghost3", "assets/Ghost3.png");
        this.load.image("ghost4", "assets/Ghost4.png");
      }

      function create() {
        var map = this.make.tilemap({
          key: "map",
          tileWidth: 32,
          tileHeight: 32,
        });
        var tileset = map.addTilesetImage("tiles", null, 32, 32, 1, 2);
        var layer = map.createLayer(0, tileset, 0, 0);

        var player = this.physics.add.image(32 + 16, 32 + 16, "pacman");
        var ghost1 = this.add.image(256 + 16, 320 + 16, "ghost1");
        var ghost2 = this.add.image(288 + 16, 320 + 16, "ghost2");
        var ghost3 = this.add.image(320 + 16, 320 + 16, "ghost3");
        var ghost4 = this.add.image(288 + 16, 288 + 16, "ghost4");


    var physics = this.physics
    var input = this.input

    //  Left
    this.input.keyboard.on('keydown-Q', function (event) {
        
        var tile = layer.getTileAtWorldXY(player.x - 32, player.y, true);

        while(tile.index !== 2){
            var tile = layer.getTileAtWorldXY(tile.pixelX - 32, tile.pixelY, true);
        }

        console.log(player.x-tile.pixelX)
        if(player.x-tile.pixelX > 32 + 18){
            block = physics.add.image(tile.pixelX +16 +5,tile.pixelY +16 , 'tile');
            block.visible = true;
            console.log(block)

            // Move at 100 px/s:
            player.setVelocity(-100, 0);

            var collider = physics.add.overlap(player, block, function (playerOnBlock)
            {
                playerOnBlock.body.stop();
    
                physics.world.removeCollider(collider);
            }, null, this);
        }


    });

    //  Right
    this.input.keyboard.on('keydown-D', function (event) {

        var tile = layer.getTileAtWorldXY(player.x , player.y, true);

        while(tile.index !== 2){
            var tile = layer.getTileAtWorldXY(tile.pixelX + 32, tile.pixelY, true);
        }
        console.log(player.x-tile.pixelX)
        if(player.x-tile.pixelX < -18){
            block = physics.add.image(tile.pixelX +16 -5,tile.pixelY +16, 'tile');
            block.visible = true;
            console.log(block)

            // Move at 100 px/s:
            player.setVelocity(+100, 0);

        }

        var collider = physics.add.overlap(player, block, function (playerOnBlock){
            playerOnBlock.body.stop();
            physics.world.removeCollider(collider);
        }, null, this);

    });

    //  Up
    this.input.keyboard.on('keydown-Z', function (event) {

        var tile = layer.getTileAtWorldXY(player.x, player.y - 32, true);

        while(tile.index !== 2){
            var tile = layer.getTileAtWorldXY(tile.pixelX , tile.pixelY -32, true);
        }

        console.log(player.y-tile.pixelY)
        if(player.y-tile.pixelY > +32+18){
            block = physics.add.image(tile.pixelX +16 ,tile.pixelY +16 +5, 'tile');
            block.visible = true;
            console.log(block)

            // Move at 100 px/s:
            player.setVelocity(0, -100);

            var collider = physics.add.overlap(player, block, function (playerOnBlock)
            {
                playerOnBlock.body.stop();
    
                physics.world.removeCollider(collider);
            }, null, this);
        }


    });

    //  Down
    this.input.keyboard.on('keydown-S', function (event) {

        var tile = layer.getTileAtWorldXY(player.x, player.y + 32, true);

        while(tile.index !== 2){
            var tile = layer.getTileAtWorldXY(tile.pixelX , tile.pixelY +32, true);
        }

        console.log(player.y-tile.pixelY)
        if(player.y-tile.pixelY < -32 +14){
            block = physics.add.image(tile.pixelX +16 ,tile.pixelY +16 -5, 'tile');
            block.visible = true;
            console.log(block)

            // Move at 100 px/s:
            player.setVelocity(0, +100);

            var collider = physics.add.overlap(player, block, function (playerOnBlock)
            {
                playerOnBlock.body.stop();
    
                physics.world.removeCollider(collider);
            }, null, this);
        }



//         block = physics.add.image(tile.pixelX +16, tile.pixelY +16 -4, 'tile');
//         block.visible = false;
//         player.setPosition(player.x,player.y -2);

        
//         // Move at 100 px/s:
//         physics.moveToObject(player, block, 100);

// var collider = physics.add.overlap(player, block, function (playerOnBlock)
// {
//     playerOnBlock.body.stop();

//     physics.world.removeCollider(collider);
// }, null, this);


     });

}

      //   //  Left

      //   this.input.keyboard.on("keydown-Q", function (event) {
      //     var tile = layer.getTileAtWorldXY(player.x - 32, player.y, true);

      //     if (tile.index === 2) {
      //       //  Blocked, we can't move
      //     } else {
      //       player.x -= 32;
      //       player.angle = 180;
      //     }
      //   });

      //   this.input.keyboard.on("keydown-LEFT", function (event) {
      //     var tile = layer.getTileAtWorldXY(player.x - 32, player.y, true);

      //     if (tile.index === 2) {
      //       //  Blocked, we can't move
      //     } else {
      //       player.x -= 32;
      //       player.angle = 180;
      //     }
      //   });

      
    </script>
  </body>
</html>
