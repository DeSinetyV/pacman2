<!DOCTYPE html>
<html>
  <head>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  </head>
  <body>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: 607,
        height: 703,
        parent: "phaser-example",
        pixelArt: true,
        backgroundColor: "#1a1a2d",
        physics: {
        default: 'arcade',
        arcade: { debug: true }
    },
        scene: {
          preload: preload,
          create: create,
          update: update
        },
      };

      var game = new Phaser.Game(config);

      this.player = null;
      this.map = null;
      this.layer = null;
      var directions = [];
      var previousDirection = null;
      var currentDirection = null;
      var pileCount = 0;

      function preload() {
        this.load.image("tiles", "assets/drawtiles-spaced.png");
        this.load.image("pacman", "assets/Pacman.png");
        this.load.tilemapCSV("map", "assets/grid.csv");
        this.load.image("ghost1", "assets/Ghost1.png");
        this.load.image("ghost2", "assets/Ghost2.png");
        this.load.image("ghost3", "assets/Ghost3.png");
        this.load.image("ghost4", "assets/Ghost4.png");
        this.load.image("mucnh","assets/pacman (1).png")
      }

      function create() {

         map = this.make.tilemap({
          key: "map",
          tileWidth: 32,
          tileHeight: 32,
        });
        var tileset = map.addTilesetImage("tiles", null, 32, 32, 1, 2);
        layer = map.createLayer(0, tileset, 0, 0);

        map.setCollision(20, true, this.layer);

        player = this.physics.add.image(32 + 16, 32 + 16, "pacman");

        var ghost1 = this.add.image(256 + 16, 320 + 16, "ghost1");
        var ghost2 = this.add.image(288 + 16, 320 + 16, "ghost2");
        var ghost3 = this.add.image(320 + 16, 320 + 16, "ghost3");
        var ghost4 = this.add.image(288 + 16, 288 + 16, "ghost4");

        const physics = this.physics

        //  Left
        this.input.keyboard.on('keydown-Q', function (event) {
            currentDirection='left'
            var tile = layer.getTileAtWorldXY(player.x - 32, player.y, true);

            while(tile.index !== 2){
                var tile = layer.getTileAtWorldXY(tile.pixelX - 32, tile.pixelY, true);
            }

            if(player.x-tile.pixelX > 32 + 18){
                Center(player,tile);
                block = physics.add.image(tile.pixelX +16 +5,tile.pixelY +16 , 'tile');
                block.visible = true;
                previousDirection='left';
                console.log(block)

                // Move at 100 px/s:
                player.setVelocity(-100, 0);

                Collider(player, block)
            }
        });

        //  Right
        this.input.keyboard.on('keydown-D', function (event) {
            currentDirection='right'
            var tile = layer.getTileAtWorldXY(player.x , player.y, true);

            while(tile.index !== 2){
                var tile = layer.getTileAtWorldXY(tile.pixelX + 32, tile.pixelY, true);
            }
            console.log(player.x-tile.pixelX)
            if(player.x-tile.pixelX < -18){
                Center(player,tile);
                block = physics.add.image(tile.pixelX +16 -5,tile.pixelY +16, 'tile');
                block.visible = true;
                previousDirection='right';
                
                console.log(block)
                
                // Move at 100 px/s:
                player.setVelocity(+100, 0);
                
                Collider(player, block)
            }
        });
            
        //  Up
        this.input.keyboard.on('keydown-Z', function (event) {
            currentDirection='up'
            var tile = layer.getTileAtWorldXY(player.x, player.y - 32, true);

            while(tile.index !== 2){
                var tile = layer.getTileAtWorldXY(tile.pixelX , tile.pixelY -32, true);
            }

            if(player.y-tile.pixelY > +32+18){
                Center(player,tile);
                block = physics.add.image(tile.pixelX +16 ,tile.pixelY +16 +5, 'tile');
                block.visible = true;
                previousDirection='up';

                // Move at 100 px/s:
                player.setVelocity(0, -100);

                Collider(player, block)
            }
        });

        //  Down
        this.input.keyboard.on('keydown-S', function (event) {
            currentDirection='down'

            var tile = layer.getTileAtWorldXY(player.x, player.y + 32, true);

            while(tile.index !== 2){
                var tile = layer.getTileAtWorldXY(tile.pixelX , tile.pixelY +32, true);
            }

            // console.log(player.y-tile.pixelY)
            if(player.y-tile.pixelY < -32 +14){
                Center(player,tile);
                block = physics.add.image(tile.pixelX +16 ,tile.pixelY +16 -5, 'tile');
                block.visible = true;
                previousDirection='down';

                // Move at 100 px/s:
                player.setVelocity(0, +100);
                
                Collider(player, block)
            }
        });

        function Center(player,tile){
            
            if (previousDirection ==='up'){
                block.destroy();
                if((player.y-16)%32 <16){player.y -= (player.y-16)%32}
                else  player.y += 32-((player.y-16)%32)
                }

            if (previousDirection ==='down'){
                block.destroy();
                if((player.y-16)%32 >16){player.y += (32-(player.y-16)%32)}
                else player.y -= (player.y-16)%32
            }
            
            if (previousDirection ==='right'){
                block.destroy();
                if((player.x-16)%32 >16){player.x += 32-((player.x-16)%32)}   
                else player.x -= (player.x-16)%32
            }

            if (previousDirection ==='left'){
                block.destroy();
                if((player.y-16)%32 <16){player.x -= (player.x-16)%32}
                else  player.x += 32-((player.x-16)%32)
            }
        }  
        function Collider(player, block){
            var collider = physics.add.overlap(player, block, function (playerOnBlock){
                playerOnBlock.body.stop();
                physics.world.removeCollider(collider);
            }, null, this);
        }
     }

function update() {

  var x = (Math.ceil(player.x/32)-1);
  var y = (Math.ceil(player.y/32)-1);

  directions['none']  = map.getTileAt(x, y);
  directions['left']  = map.getTileAt(x-1, y);
  directions['right']  = map.getTileAt(x+1, y);
  directions['up']  = map.getTileAt(x, y-1);
  directions['down'] =map.getTileAt(x, y+1);

    if(directions['none'].index === 3) { 
        directions['none'].index = 0;
        pileCount++;
    console.log(pileCount);
    }
}
    </script>
  </body>
</html>
